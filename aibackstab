-- Services
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

-- Debugging function
local function log(message)
    print("[BackstabGUI] " .. message)
end

log("Script started")

-- ================== MAIN GUI ==================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BackstabGUI"
ScreenGui.Parent = game:GetService("CoreGui")
ScreenGui.ResetOnSpawn = false
ScreenGui.Enabled = true

log("ScreenGui created and parented to CoreGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 280, 0, 400)
Frame.Position = UDim2.new(0.5, -140, 0.5, -200)
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui
Frame.Active = true
Frame.Draggable = true
Frame.Visible = true

log("Main Frame created")

local FrameCorner = Instance.new("UICorner")
FrameCorner.CornerRadius = UDim.new(0, 12)
FrameCorner.Parent = Frame

local Shadow = Instance.new("Frame")
Shadow.Size = UDim2.new(1, 6, 1, 6)
Shadow.Position = UDim2.new(0, -3, 0, -3)
Shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Shadow.BackgroundTransparency = 0.8
Shadow.BorderSizePixel = 0
Shadow.ZIndex = Frame.ZIndex - 1
Shadow.Parent = Frame

local ShadowCorner = Instance.new("UICorner")
ShadowCorner.CornerRadius = UDim.new(0, 15)
ShadowCorner.Parent = Shadow

local HeaderBar = Instance.new("Frame")
HeaderBar.Size = UDim2.new(1, 0, 0, 50)
HeaderBar.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
HeaderBar.BorderSizePixel = 0
HeaderBar.Parent = Frame

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 12)
HeaderCorner.Parent = HeaderBar

local HeaderBottom = Instance.new("Frame")
HeaderBottom.Size = UDim2.new(1, 0, 0, 12)
HeaderBottom.Position = UDim2.new(0, 0, 1, -12)
HeaderBottom.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
HeaderBottom.BorderSizePixel = 0
HeaderBottom.Parent = HeaderBar

local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -40, 0, 10)
CloseButton.Text = "√ó"
CloseButton.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
CloseButton.TextColor3 = Color3.new(1, 1, 1)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 18
CloseButton.BorderSizePixel = 0
CloseButton.Parent = HeaderBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 6)
CloseCorner.Parent = CloseButton

CloseButton.MouseEnter:Connect(function()
    TweenService:Create(CloseButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 80, 80)}):Play()
end)
CloseButton.MouseLeave:Connect(function()
    TweenService:Create(CloseButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(220, 60, 60)}):Play()
end)

CloseButton.MouseButton1Click:Connect(function()
    TweenService:Create(Frame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
        Size = UDim2.new(0, 0, 0, 0),
        Position = UDim2.new(0.5, 0, 0.5, 0)
    }):Play()
    task.wait(0.3)
    ScreenGui:Destroy()
    log("GUI closed")
end)

local TitleIcon = Instance.new("TextLabel")
TitleIcon.Size = UDim2.new(0, 30, 0, 30)
TitleIcon.Position = UDim2.new(0, 15, 0, 10)
TitleIcon.Text = "üó°Ô∏è"
TitleIcon.BackgroundTransparency = 1
TitleIcon.TextColor3 = Color3.fromRGB(100, 200, 255)
TitleIcon.Font = Enum.Font.Gotham
TitleIcon.TextSize = 16
TitleIcon.Parent = HeaderBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(0, 180, 0, 30)
TitleLabel.Position = UDim2.new(0, 50, 0, 10)
TitleLabel.Text = "Auto Backstab"
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextColor3 = Color3.new(1, 1, 1)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 16
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = HeaderBar

local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -20, 1, -70)
ContentFrame.Position = UDim2.new(0, 10, 0, 60)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = Frame

local InputSection = Instance.new("Frame")
InputSection.Size = UDim2.new(1, 0, 0, 100)
InputSection.BackgroundTransparency = 1
InputSection.Parent = ContentFrame

local function styleTextBox(textbox, placeholder)
    textbox.BackgroundColor3 = Color3.fromRGB(35, 35, 42)
    textbox.BorderSizePixel = 0
    textbox.TextColor3 = Color3.new(1, 1, 1)
    textbox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    textbox.Font = Enum.Font.Gotham
    textbox.TextSize = 14
    textbox.PlaceholderText = placeholder
    textbox.ClearTextOnFocus = false
    textbox.TextXAlignment = Enum.TextXAlignment.Left
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = textbox
    
    local padding = Instance.new("UIPadding")
    padding.PaddingLeft = UDim.new(0, 12)
    padding.PaddingRight = UDim.new(0, 12)
    padding.Parent = textbox
    
    textbox.Focused:Connect(function()
        TweenService:Create(textbox, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(45, 45, 55),
            BorderSizePixel = 2,
            BorderColor3 = Color3.fromRGB(100, 200, 255)
        }):Play()
    end)
    
    textbox.FocusLost:Connect(function()
        TweenService:Create(textbox, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(35, 35, 42),
            BorderSizePixel = 0
        }):Play()
    end)
end

local ModeTextbox = Instance.new("TextBox")
ModeTextbox.Size = UDim2.new(1, 0, 0, 35)
ModeTextbox.Position = UDim2.new(0, 0, 0, 0)
ModeTextbox.Parent = InputSection
styleTextBox(ModeTextbox, "Mode (Normal/Around)")

local DistanceTextbox = Instance.new("TextBox")
DistanceTextbox.Size = UDim2.new(1, 0, 0, 35)
DistanceTextbox.Position = UDim2.new(0, 0, 0, 50)
DistanceTextbox.Text = "10"
DistanceTextbox.Parent = InputSection
styleTextBox(DistanceTextbox, "Distance (studs)")

local ControlSection = Instance.new("Frame")
ControlSection.Size = UDim2.new(1, 0, 0, 120)
ControlSection.Position = UDim2.new(0, 0, 0, 120)
ControlSection.BackgroundTransparency = 1
ControlSection.Parent = ContentFrame

local function createToggleButton(text, position, parent)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 50, 0, 35)
    button.Position = position
    button.Text = text
    button.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
    button.TextColor3 = Color3.new(1, 1, 1)
    button.Font = Enum.Font.GothamSemibold
    button.TextSize = 9
    button.BorderSizePixel = 0
    button.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = button
    
    button.MouseEnter:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(80, 80, 90)}):Play()
    end)
    button.MouseLeave:Connect(function()
        local color = button.Text:find("ON") and Color3.fromRGB(50, 150, 100) or Color3.fromRGB(60, 60, 70)
        TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = color}):Play()
    end)
    
    return button
end

local ToggleButton = createToggleButton("Auto: OFF", UDim2.new(0, 0, 0, 0), ControlSection)
local NoCooldownButton = createToggleButton("No CD: OFF", UDim2.new(0, 55, 0, 0), ControlSection)
local RoundStartStabButton = createToggleButton("Round Start: OFF", UDim2.new(0, 110, 0, 0), ControlSection)
local ESPButton = createToggleButton("ESP: OFF", UDim2.new(0, 165, 0, 0), ControlSection)
local StaminaInjectButton = createToggleButton("Stamina: OFF", UDim2.new(0, 220, 0, 0), ControlSection)

local StatusSection = Instance.new("Frame")
StatusSection.Size = UDim2.new(1, 0, 0, 60)
StatusSection.Position = UDim2.new(0, 0, 0, 290)
StatusSection.BackgroundTransparency = 1
StatusSection.Parent = ContentFrame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Position = UDim2.new(0, 0, 0, 0)
StatusLabel.Text = "Ready"
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(100, 200, 100)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 12
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = StatusSection

local CooldownBarBg = Instance.new("Frame")
CooldownBarBg.Size = UDim2.new(1, 0, 0, 12)
CooldownBarBg.Position = UDim2.new(0, 0, 0, 30)
CooldownBarBg.BackgroundColor3 = Color3.fromRGB(40, 40, 48)
CooldownBarBg.BorderSizePixel = 0
CooldownBarBg.Parent = StatusSection

local CooldownBarCorner = Instance.new("UICorner")
CooldownBarCorner.CornerRadius = UDim.new(0, 6)
CooldownBarCorner.Parent = CooldownBarBg

local CooldownBar = Instance.new("Frame")
CooldownBar.Size = UDim2.new(1, 0, 1, 0)
CooldownBar.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
CooldownBar.BorderSizePixel = 0
CooldownBar.Parent = CooldownBarBg

local CooldownProgressCorner = Instance.new("UICorner")
CooldownProgressCorner.CornerRadius = UDim.new(0, 6)
CooldownProgressCorner.Parent = CooldownBar

local Gradient = Instance.new("UIGradient")
Gradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(100, 200, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 160, 255))
})
Gradient.Parent = CooldownBar

-- ================== Helper Functions ==================
local function getFirstKiller()
    local killersFolder = workspace.Players:FindFirstChild("Killers")
    if not killersFolder then return nil end
    for _, k in pairs(killersFolder:GetChildren()) do
        if k:FindFirstChild("HumanoidRootPart") then
            return k
        end
    end
    return nil
end

local function fireRemote(ability)
    local args = {"UseActorAbility", {buffer.fromstring("\"" .. ability .. "\"")}}
    local remote = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Network"):WaitForChild("RemoteEvent")
    remote:FireServer(unpack(args))
    log("Fired remote for ability: " .. ability)
end

local function getBackPosition(killerHRP)
    return killerHRP.Position - killerHRP.CFrame.LookVector * 4
end

local function isAtBack(myHRP, killerHRP)
    local toMyPos = (myHRP.Position - killerHRP.Position).Unit
    local dot = toMyPos:Dot(killerHRP.CFrame.LookVector)
    return dot < 0
end

local function SmartBackstab(mode, originalPos)
    local killer = getFirstKiller()
    local character = LocalPlayer.Character
    if not killer or not character then
        log("SmartBackstab failed: No killer or character")
        return
    end
    local myHRP = character:FindFirstChild("HumanoidRootPart")
    local killerHRP = killer:FindFirstChild("HumanoidRootPart")
    if not myHRP or not killerHRP then
        log("SmartBackstab failed: No HRP found")
        return
    end

    local fired = false
    local radius = 4
    local followEndTime = nil

    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not myHRP or not killerHRP then
            connection:Disconnect()
            log("SmartBackstab stopped: HRP missing")
            return
        end

        if followEndTime and tick() >= followEndTime then
            if originalPos then
                local tween = TweenService:Create(myHRP, TweenInfo.new(0.5, Enum.EasingStyle.Linear), {CFrame = CFrame.new(originalPos)})
                tween:Play()
                log("Tweening back to original position")
            end
            connection:Disconnect()
            return
        end

        local backPos = getBackPosition(killerHRP)
        local toMyPos = (myHRP.Position - killerHRP.Position).Unit
        local dot = toMyPos:Dot(killerHRP.CFrame.LookVector)
        local targetPos = backPos

        if mode == "Around" and dot > 0 then
            local perp = Vector3.new(-killerHRP.CFrame.LookVector.Z, 0, killerHRP.CFrame.LookVector.X) * radius
            targetPos = backPos + perp
        end

        local tween = TweenService:Create(myHRP, TweenInfo.new(0.1, Enum.EasingStyle.Linear), {CFrame = CFrame.new(targetPos, killerHRP.Position)})
        tween:Play()

        if not fired and isAtBack(myHRP, killerHRP) then
            fired = true
            fireRemote("Dagger")
            followEndTime = tick() + 0.2
            log("Dagger ability fired")
        end
    end)
end

-- ================== Stamina Inject Logic ==================
local SprintingModule
local StaminaInjectEnabled = false

pcall(function()
    SprintingModule = require(ReplicatedStorage:WaitForChild("Systems"):WaitForChild("Character"):WaitForChild("Game"):WaitForChild("Sprinting"))
    log("Sprinting module loaded successfully")
end)

local function toggleStaminaInject(enabled)
    if not SprintingModule then
        log("Stamina Inject failed: Sprinting module not found")
        StatusLabel.Text = "Stamina Inject: Module not found"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end
    if enabled then
        SprintingModule.StaminaLossDisabled = true
        SprintingModule.MinStamina = -30000000000000000000
        SprintingModule.StaminaGain = 25
        SprintingModule.StaminaLoss = 0
        SprintingModule.SprintSpeed = 28
        log("Stamina Inject enabled")
    else
        SprintingModule.StaminaLossDisabled = false
        SprintingModule.MinStamina = 0
        SprintingModule.StaminaGain = 10
        SprintingModule.StaminaLoss = 10
        SprintingModule.SprintSpeed = 16
        log("Stamina Inject disabled")
    end
end

-- ================== ESP Logic ==================
local ESPEnabled = false
local highlights = {}

local function addHighlight(player)
    if player == LocalPlayer then return end
    local character = player.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESPHighlight"
        highlight.FillColor = Color3.fromRGB(255, 0, 0)
        highlight.FillTransparency = 0.7
        highlight.OutlineColor = Color3.fromRGB(255, 0, 0)
        highlight.OutlineTransparency = 0
        highlight.Adornee = character
        highlight.Parent = character
        highlights[player] = highlight
        log("Added ESP highlight for player: " .. player.Name)

        player.CharacterAdded:Connect(function(newCharacter)
            if ESPEnabled then
                local newHighlight = Instance.new("Highlight")
                newHighlight.Name = "ESPHighlight"
                newHighlight.FillColor = Color3.fromRGB(255, 0, 0)
                newHighlight.FillTransparency = 0.7
                newHighlight.OutlineColor = Color3.fromRGB(255, 0, 0)
                newHighlight.OutlineTransparency = 0
                newHighlight.Adornee = newCharacter
                newHighlight.Parent = newCharacter
                highlights[player] = newHighlight
                log("Re-added ESP highlight for player: " .. player.Name)
            end
        end)
    end
end

local function removeHighlight(player)
    if highlights[player] then
        highlights[player]:Destroy()
        highlights[player] = nil
        log("Removed ESP highlight for player: " .. player.Name)
    end
end

local function toggleESP(enabled)
    if enabled then
        for _, player in pairs(Players:GetPlayers()) do
            addHighlight(player)
        end
    else
        for player, highlight in pairs(highlights) do
            if highlight then
                highlight:Destroy()
            end
        end
        highlights = {}
        log("ESP disabled, all highlights removed")
    end
end

Players.PlayerAdded:Connect(function(player)
    if ESPEnabled then
        addHighlight(player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    removeHighlight(player)
end)

-- ================== Toggles ==================
local AutoBackstabEnabled = false
local NoCooldownEnabled = false
local RoundStartStabEnabled = false
ESPEnabled = false
StaminaInjectEnabled = false
local cooldown = false
local currentCooldownTime = 0
local defaultCooldownDuration = 30
local noCooldownDuration = 3

local function updateToggleButton(button, enabled, text)
    local newText = text .. (enabled and ": ON" or ": OFF")
    button.Text = newText
    local color = enabled and Color3.fromRGB(50, 150, 100) or Color3.fromRGB(60, 60, 70)
    TweenService:Create(button, TweenInfo.new(0.3), {BackgroundColor3 = color}):Play()
    log("Toggled " .. text .. " to " .. (enabled and "ON" or "OFF"))
end

ToggleButton.MouseButton1Click:Connect(function()
    AutoBackstabEnabled = not AutoBackstabEnabled
    updateToggleButton(ToggleButton, AutoBackstabEnabled, "Auto")
    StatusLabel.Text = AutoBackstabEnabled and "Active - Scanning..." or "Ready"
    StatusLabel.TextColor3 = AutoBackstabEnabled and Color3.fromRGB(255, 200, 100) or Color3.fromRGB(100, 200, 100)
end)

NoCooldownButton.MouseButton1Click:Connect(function()
    NoCooldownEnabled = not NoCooldownEnabled
    updateToggleButton(NoCooldownButton, NoCooldownEnabled, "No CD")
end)

RoundStartStabButton.MouseButton1Click:Connect(function()
    RoundStartStabEnabled = not RoundStartStabEnabled
    updateToggleButton(RoundStartStabButton, RoundStartStabEnabled, "Round Start")
end)

ESPButton.MouseButton1Click:Connect(function()
    ESPEnabled = not ESPEnabled
    updateToggleButton(ESPButton, ESPEnabled, "ESP")
    toggleESP(ESPEnabled)
end)

StaminaInjectButton.MouseButton1Click:Connect(function()
    StaminaInjectEnabled = not StaminaInjectEnabled
    updateToggleButton(StaminaInjectButton, StaminaInjectEnabled, "Stamina")
    toggleStaminaInject(StaminaInjectEnabled)
end)

-- ================== Backstab on Round Start Logic ==================
local function onKillerAdded(killer)
    if not RoundStartStabEnabled then return end
    if not killer:FindFirstChild("HumanoidRootPart") then
        log("Round start backstab skipped: No HRP for killer")
        return
    end

    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        log("Round start backstab skipped: No character or HRP")
        return
    end

    local myHRP = character.HumanoidRootPart
    local originalPos = myHRP.Position
    StatusLabel.Text = "Round Start Backstab..."
    StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    SmartBackstab("Normal", originalPos)
    task.wait(0.7)
    StatusLabel.Text = AutoBackstabEnabled and "Active - Scanning..." or "Ready"
    StatusLabel.TextColor3 = AutoBackstabEnabled and Color3.fromRGB(255, 200, 100) or Color3.fromRGB(100, 200, 100)
    log("Round start backstab executed")
end

local killersFolder = workspace.Players:WaitForChild("Killers")
killersFolder.ChildAdded:Connect(onKillerAdded)

-- ================== Cooldown Logic ==================
local function updateCooldownBar()
    if cooldown then
        currentCooldownTime = math.max(currentCooldownTime - RunService.Heartbeat:Wait(), 0)
        local progress = currentCooldownTime / (NoCooldownEnabled and noCooldownDuration or defaultCooldownDuration)
        CooldownBar.Size = UDim2.new(1 - progress, 0, 1, 0)
        
        if currentCooldownTime <= 0 then
            cooldown = false
            StatusLabel.Text = AutoBackstabEnabled and "Active - Scanning..." or "Ready"
            StatusLabel.TextColor3 = AutoBackstabEnabled and Color3.fromRGB(255, 200, 100) or Color3.fromRGB(100, 200, 100)
            log("Cooldown ended")
        end
    end
end

-- ================== Main Loop ==================
RunService.Heartbeat:Connect(function()
    if AutoBackstabEnabled then
        local mode = ModeTextbox.Text:lower()
        if mode ~= "normal" and mode ~= "around" then
            mode = "normal"
        end
        
        local distance = tonumber(DistanceTextbox.Text) or 10
        if distance < 1 then
            distance = 1
        end
        
        if not cooldown then
            local killer = getFirstKiller()
            if killer then
                local character = LocalPlayer.Character
                if character and character:FindFirstChild("HumanoidRootPart") then
                    local killerHRP = killer:FindFirstChild("HumanoidRootPart")
                    if killerHRP then
                        local distanceToKiller = (killerHRP.Position - character.HumanoidRootPart.Position).Magnitude
                        if distanceToKiller <= distance then
                            StatusLabel.Text = "Executing Backstab..."
                            StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
                            SmartBackstab(mode)
                            cooldown = true
                            currentCooldownTime = NoCooldownEnabled and noCooldownDuration or defaultCooldownDuration
                            log("Auto backstab executed")
                        else
                            StatusLabel.Text = "Target out of range"
                            StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
                        end
                    end
                end
            else
                StatusLabel.Text = "No target found"
                StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
            end
        end
    end
    
    updateCooldownBar()
end)

-- ================== Input Validation ==================
ModeTextbox:GetPropertyChangedSignal("Text"):Connect(function()
    local text = ModeTextbox.Text:lower()
    if text ~= "normal" and text ~= "around" then
        ModeTextbox.TextColor3 = Color3.fromRGB(255, 100, 100)
    else
        ModeTextbox.TextColor3 = Color3.new(1, 1, 1)
    end
end)

DistanceTextbox:GetPropertyChangedSignal("Text"):Connect(function()
    local distance = tonumber(DistanceTextbox.Text)
    if not distance or distance < 1 then
        DistanceTextbox.TextColor3 = Color3.fromRGB(255, 100, 100)
    else
        DistanceTextbox.TextColor3 = Color3.new(1, 1, 1)
    end
end)

log("Script initialization complete")
